# Journal - 2026-02-01 (Sunday)

## Summary

Fixed 2FA retry issue: IBC now automatically retries login every 3 minutes if 2FA times out, instead of waiting for the next hourly cron.

---

## Issue: Only One 2FA Notification Per Restart

### Problem

User missed Sunday 2FA and noticed they only got one push notification, even though the hourly cron restarted the gateway multiple times (10 AM, 11 AM, 12 PM, 1 PM).

### Root Cause

Each hourly restart DID trigger a new 2FA dialog in the gateway, but:
1. IBKR mobile app only sends ONE push notification per "session"
2. Subsequent 2FA dialogs appeared silently (no phone notification)
3. After 3 min timeout, gateway just sat there until next hourly restart

### Solution

Added `RELOGIN_AFTER_TWOFA_TIMEOUT=yes` environment variable to docker-compose.yml.

This tells IBC (IB Controller) to automatically restart the login sequence when 2FA times out, which:
- Triggers a NEW 2FA request immediately
- IBKR sends a fresh push notification (new login attempt)
- Retries every ~3 minutes indefinitely until approved

---

## Fix Details

### docker-compose.yml (ib-gateway service)

```yaml
environment:
  # ... existing vars ...
  TWOFA_TIMEOUT_ACTION: "restart"
  RELOGIN_AFTER_TWOFA_TIMEOUT: "yes"  # NEW - retry login after 2FA timeout
```

### How It Works

The gnzsnz/ib-gateway image generates `config.ini` from a template on startup using environment variables:

| Env Var | Config Setting | Effect |
|---------|---------------|--------|
| `RELOGIN_AFTER_TWOFA_TIMEOUT` | `ReloginAfterSecondFactorAuthenticationTimeout` | Auto-retry after 2FA timeout |

### Timing

| Event | Duration |
|-------|----------|
| 2FA prompt appears | - |
| Time to approve | 180 sec (3 min) |
| If expired â†’ retry | Immediate |
| New 2FA prompt | 180 sec |
| ... | Infinite loop |

---

## Verification

Tested by letting 2FA expire:

| Time | Event |
|------|-------|
| 13:58:06 | First 2FA (Attempt 2) |
| 14:00:10 | Auto-relogin after timeout |
| 14:00:58 | Second 2FA (Attempt 3) - new push notification received |

Confirmed user received second push notification on phone.

---

## Trade Execution

Manual trade triggered after 2FA login (scheduled trade failed due to connection drop at 09:31):

| Field | Value |
|-------|-------|
| Contract | SPY 625P 2026-04-30 |
| Action | SELL 1 |
| Fill Price | $6.13 |
| Delta | -0.1497 |
| Commission | $0.70 |
| Fill Time | 09:38:48 ET |
| Position ID | 15 |
| TP Order | $2.45 |
| SL Order | $18.39 |

---

## Files Modified

| File | Change |
|------|--------|
| `docker-compose.yml` | Added `RELOGIN_AFTER_TWOFA_TIMEOUT: "yes"` |

---

## Deployment

Fix deployed directly to EC2 via:
```bash
sed -i '/TWOFA_TIMEOUT_ACTION/a\      RELOGIN_AFTER_TWOFA_TIMEOUT: "yes"' docker-compose.yml
docker-compose up -d --force-recreate ib-gateway
```

---

## Pending

1. Commit fix to git for future deployments
2. Clean up orphaned 698P orders from 01-28 bad trade
3. Store `conId` in database for weekend position verification
