# Journal - 2026-01-24

## Summary

Debugging day. Fixed multiple dashboard issues after yesterday's refactoring: deadlock in connection manager, missing data keys, and SFTP testing with IBKR. Identified PGP decryption issue (IBKR used wrong key).

---

## Completed

### 1. Fixed Dashboard Deadlock

Dashboard `/api/connection-status` was timing out.

**Root cause:** `get_all()` called `get_positions()` while holding `threading.Lock()`, but `get_positions()` also tried to acquire the same lock. Non-reentrant lock caused deadlock.

**Fix:** Changed `threading.Lock()` to `threading.RLock()` (reentrant lock).

```python
# Before
self._lock = threading.Lock()

# After
self._lock = threading.RLock()  # Reentrant lock for nested calls
```

### 2. Fixed Missing ibkr_positions Key

Dashboard showed Internal Server Error: `KeyError: 'ibkr_positions'`

**Root cause:** When subprocesses were removed, `get_all()` no longer returned `ibkr_positions`.

**Temporary fix:** Added `data["ibkr_positions"] = []` (later properly fixed on 01-25).

### 3. Added Price Source Fallback

P&L was null when market closed because options don't have bid/ask after hours.

**Fix:** Added fallback chain: bid/ask mid → last → close

```python
if _is_valid(ticker.bid) and _is_valid(ticker.ask):
    position_data.current_price = (ticker.bid + ticker.ask) / 2
    position_data.price_source = "bid_ask"
elif _is_valid(ticker.last):
    position_data.current_price = ticker.last
    position_data.price_source = "last"
elif _is_valid(ticker.close):
    position_data.current_price = ticker.close
    position_data.price_source = "close"
```

### 4. SFTP Testing with IBKR

Successfully tested SFTP connection to IBKR for margin report delivery.

**Connection:** Works via RSA key authentication
- Host: ftp2.interactivebrokers.com
- Username: ibkrmarginreport
- Auth: RSA key at `~/.ssh/ibkr_sftp_rsa`

**Downloaded:** `IBKRtest.txt.pgp` test file

**Issue:** PGP decryption failed - IBKR encrypted with wrong key:
- Our key ID: `CB8958A6EC3AF1C3`
- IBKR used: `143E5B91E3F18BA4`

Drafted email to IBKR requesting they re-import the correct PGP key.

---

## Technical Details

### Why threading.Lock() caused deadlock

```python
def get_all(self):
    with self._lock:           # Acquires lock
        return {
            ...
            "positions": self.get_positions(),  # Tries to acquire same lock!
        }

def get_positions(self):
    with self._lock:           # DEADLOCK - lock already held
        ...
```

`threading.Lock()` is non-reentrant - same thread cannot acquire it twice.
`threading.RLock()` allows same thread to acquire multiple times.

---

## Files Modified

| File | Change |
|------|--------|
| `connection_manager.py` | RLock, price_source fallback |
| `api.py` | Temporary ibkr_positions = [] |

---

## Commits

1. `Fix deadlock in connection manager: use RLock instead of Lock` - ca6fcb4
2. `Fix missing ibkr_positions key in dashboard data` - 03188bd
3. `Add price_source fallback: use last/close when bid/ask unavailable` - b3f579a
4. `Add on_ibkr field to verify positions exist on broker` - 91ef0ee
5. `Update dashboard to show Live/DB Only from on_ibkr field` - 807c496

---

## Pending

1. IBKR needs to re-import correct PGP key for file decryption
2. Position verification shows "Live" even when not connected (stale cache)
