# Journal - 2026-02-04 (Wednesday)

## Summary

Discovered and fixed critical connection manager bug. Trade executed successfully after gateway restart. Verified execution callback works on paper trading.

---

## Trade Executed

| Field | Value |
|-------|-------|
| Contract | SPY 624P 2026-04-30 |
| Action | SELL 1 |
| Fill Price | $6.16 |
| Position ID | 18 |
| Fill Time | 09:42:00 ET |

Note: Scheduled 09:35 trade missed because gateway was disconnected. Executed manually after reconnection.

---

## Bug Found: Connection Manager Status Not Updating

### Symptoms

Dashboard showed `connected=true` but cache timestamp was frozen for 35+ minutes. Gateway was actually disconnected (user logged into TWS on laptop).

### Root Cause (Initial)

In `connection_manager.py`, the `else` branch when `ib.isConnected()` returns `False` did not update the status.

### Root Cause (Deeper)

The initial fix didn't work because `ib.isConnected()` only checks if the **socket** between trading-bot and IB Gateway is open. When Error 1100 fires ("Connectivity lost between IB and TWS"), the gateway is disconnected from IBKR servers, but the socket from trading-bot to gateway is still open.

```
trading-bot ──socket──> IB Gateway ──X──> IBKR Servers
             isConnected()=True        Error 1100
```

### Fix Applied (Complete)

Added error event handler to detect Error 1100/1101/1102/2110:

```python
# Track connection state from error events
self._gateway_connected: bool = False

def _register_error_handler(self):
    """Register error handler to detect connectivity loss."""
    self.ib.errorEvent += self._on_error

def _on_error(self, reqId, errorCode, errorString, contract):
    if errorCode == 1100:
        # Connectivity lost
        self._gateway_connected = False
        self._update_status(connected=False, error=f"Error {errorCode}: {errorString}")
    elif errorCode in (1101, 1102, 2110):
        # Connectivity restored
        self._gateway_connected = True
```

Main loop now checks both:
```python
if self.ib.isConnected() and self._gateway_connected:
    self._update_cache()
```

---

## Discovery: IB Gateway Socat Proxy

### Problem

Local Docker couldn't connect to IB Gateway. TCP connection succeeded but gateway returned 0 bytes.

### Root Cause

IB Gateway only accepts connections from `localhost` (127.0.0.1) due to `TrustedIPs` setting. The gnzsnz/ib-gateway image uses **socat** as proxy:

| Mode | Direct Port | Socat Proxy Port | Use This |
|------|-------------|------------------|----------|
| Live | 4001 | 4003 | 4003 |
| Paper | 4002 | 4004 | 4004 |

### Solution

1. Set `TWS_DOCKER_PORT=4004` in `.env` for paper (4003 for live)
2. Use `docker-compose.override.yml` (gitignored) for local port exposures

See `learning.md` for full documentation.

---

## Execution Callback Verified

Tested on paper trading:

| Test | Result |
|------|--------|
| Placed BUY MKT order for 630P 2026-03-20 | Order filled at market open |
| Execution callback triggered | Position closed automatically |
| Trade recorded | BUY logged in trade history |

The `ib.execDetailsEvent` callback correctly detects TP/SL fills and closes positions.

---

## Missing Orders Fixed

3 positions were missing TP/SL exit orders:

| Position | Contract | TP | SL |
|----------|----------|----|----|
| 10 | 625P 2026-04-30 | 2.43 | 18.24 |
| 11 | 629P 2026-04-30 | 2.46 | 18.45 |
| 16 | 632P 2026-04-30 | 2.38 | 17.82 |

Used `create_test_position.py` script to add missing orders.

---

## Files Modified

| File | Change |
|------|--------|
| `connection_manager.py` | Fixed: update status when disconnected |
| `strategy.py` | Fixed: atomic trade attempts with order restore |
| `ibkr_client.py` | Fixed: include cancelled_orders in all failure paths |
| `learning.md` | Created: socat proxy documentation |
| `docker-compose.override.yml` | Created: local dev port exposures (gitignored) |

---

## Bug Found: Missing Orders Root Cause

### The Bug

When a new trade succeeded on first attempt, cancelled orders from conflicting positions were never restored.

### Fix 1: Atomic Trade Attempts (strategy.py)

Each attempt now restores cancelled orders immediately on failure:

```python
if result.success:
    if result.cancelled_orders:
        self.client.restore_cancelled_orders(result.cancelled_orders)
    return order, result

# Failed - immediately restore cancelled orders
if result.cancelled_orders:
    self.client.restore_cancelled_orders(result.cancelled_orders)
```

### Fix 2: Include cancelled_orders in All Failures (ibkr_client.py)

All TradeResult returns now include cancelled_orders:
- Cancel conflict failure
- Sell order not filled
- TP/SL placement failure
- Exception handler

---

## Deployment Status

All fixes deployed to EC2:
- Connection manager status fix
- Cancelled orders restore fix
- Atomic trade attempts
- Point of no return (after SELL fills, return success=True)
- Execution callback verified working

---

## Pending: TP/SL Retry After SELL Fills

### Problem

After SELL fills (point of no return), if TP/SL placement fails:
- We return success=True (correct - can't retry whole trade)
- Cancelled orders are restored by strategy.py (correct)
- But new position has no exit orders (problem!)

### Proposed Solution

Add retry logic for TP/SL placement within `ibkr_client.py`:

```python
# After SELL fills, retry TP/SL up to 3 times
for tp_sl_attempt in range(1, 4):
    # Place TP order
    # Place SL order
    # Verify
    if orders_success:
        break
    logger.warning(f"TP/SL attempt {tp_sl_attempt}/3 failed, retrying...")
    self.ib.sleep(2)

if not orders_success:
    # All TP/SL attempts failed - log error but still success=True
    logger.error("All TP/SL attempts failed - manual intervention needed")
```

### Flow Summary

```
Before SELL fills: can retry whole trade
After SELL fills:
  - Retry TP/SL placement (3 attempts)
  - Restore cancelled orders (done by strategy.py)
  - If TP/SL still fails, return success=True with warning
```

### To Discuss

1. Should TP/SL retry be 3 attempts or more?
2. What if restore_cancelled_orders fails after SELL fills?
3. Should there be a background job to detect positions without TP/SL?
