# Journal - 2026-01-25 (Sunday)

## Summary

Code cleanup and bug fixes. Properly restored `ibkr_positions` verification (lost during subprocess removal). Fixed stale cache showing "Live" when disconnected. Added hourly retry to Sunday restart cron.

---

## Completed

### 1. Restored ibkr_positions for Position Verification

Dashboard was showing "Live" even when not connected due to stale cache.

**Root cause:** When subprocesses were removed (01-23), the `ibkr_positions` data was lost. The temporary fix `ibkr_positions = []` broke position verification entirely.

**Proper fix:** Connection manager now properly caches IBKR positions:

```python
# In CachedData
ibkr_positions: list[dict] = field(default_factory=list)

# In _get_ibkr_positions()
for pos in self.ib.positions():
    c = pos.contract
    if c.secType == "OPT" and pos.position != 0:
        ibkr_positions.append({
            "symbol": c.symbol,
            "strike": c.strike,
            "expiration": exp,
            "right": getattr(c, "right", None),
            "quantity": int(pos.position),
            "avg_cost": pos.avgCost,
        })
self._cache.ibkr_positions = ibkr_positions
```

Template uses original Jinja verification:
```jinja
{% set ibkr_keys = [] %}
{% for ibkr_pos in ibkr_positions %}
    {% set key = ibkr_pos.symbol ~ '_' ~ (ibkr_pos.strike|int) ~ '_' ~ ibkr_pos.expiration %}
    {% set _ = ibkr_keys.append(key) %}
{% endfor %}

{% set is_verified = pos_key in ibkr_keys %}
```

### 2. Fixed Stale Cache When Disconnected

Positions showed "Live" even after IBKR connection dropped.

**Fix:** Clear `ibkr_positions` cache when not connected:

```python
if self.ib.isConnected():
    self._update_cache()
    self.ib.sleep(5)
else:
    # Clear IBKR positions when not connected
    self._cache.ibkr_positions = []
    self._stop_event.wait(5)
```

### 3. Cleaned Up Unused Code

Removed `on_ibkr` field that was added yesterday but never used:
- Removed from `PositionData` dataclass
- Removed from position creation
- Removed from `get_positions()` return dict
- Removed JavaScript that was updating it

### 4. Fixed Sunday Restart Cron

The hourly retry for missed 2FA was only in comments, not actually scheduled.

**Before:**
```cron
# Only primary restart at 10:00 AM
0 10 * * 0 sunday_restart.sh
```

**After:**
```cron
# Primary restart at 10:00 AM ET
0 10 * * 0 sunday_restart.sh

# Hourly retry 11 AM - 6 PM ET if missed
0 11-18 * * 0 sunday_restart.sh
```

---

## Architecture Clarification

### Position Status Display ("Live" vs "DB Only")

```
┌─────────────────────────────────────────────────────────┐
│                 Connection Manager                        │
│                                                           │
│  _get_ibkr_positions():                                  │
│    - Calls ib.positions() to get IBKR portfolio         │
│    - Stores in _cache.ibkr_positions                    │
│    - Called during _update_positions()                  │
│                                                           │
│  When disconnected:                                      │
│    - _cache.ibkr_positions = []  (cleared)              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    FastAPI / Jinja                        │
│                                                           │
│  get_all() returns ibkr_positions                        │
│  Template builds lookup: ibkr_keys[]                     │
│  For each DB position, checks if in ibkr_keys            │
│                                                           │
│  ✓ In IBKR → "Live" (green)                              │
│  ✗ Not in IBKR → "DB Only" (yellow)                      │
└─────────────────────────────────────────────────────────┘
```

---

## Verification Status

| Check | Status |
|-------|--------|
| Connection | Not connected (Sunday - pending 2FA) |
| Position Status | Shows "DB Only" (correct when disconnected) |
| Cron Retry | Added hourly retry 11-18 on Sunday |
| Code Cleanup | No unused on_ibkr, no subprocesses |

---

## Files Modified

| File | Change |
|------|--------|
| `connection_manager.py` | Added ibkr_positions cache, clear on disconnect, removed on_ibkr |
| `api.py` | Removed ibkr_positions = [] hack |
| `templates/dashboard.html` | Reverted to Jinja verification, removed JS for on_ibkr |

---

## Commits

1. `Restore ibkr_positions for position verification` - 9c572a6
2. `Remove unused on_ibkr field` - 4ba70e7
3. `Clear ibkr_positions cache when not connected` - c1277a8

---

## Current State

**No subprocesses remain** - All IBKR reads go through connection manager.

**API Endpoints:**
| Endpoint | Data Source |
|----------|-------------|
| `/api/positions` | Database |
| `/api/positions/live` | Connection Manager cache |
| `/api/summary` | Database |
| `/api/trade-history` | Database |
| `/api/spy-price` | Connection Manager cache |
| `/api/snapshots` | Database |
| `/api/connection-status` | Connection Manager |
| `/api/live-orders` | Connection Manager cache |
| `/api/gateway/restart` | Docker API |

---

## Pending

1. IBKR PGP key issue - waiting for them to re-import correct key
2. Complete 2FA to reconnect (gateway restarted, waiting for approval)
