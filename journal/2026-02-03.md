# Journal - 2026-02-03 (Tuesday)

## Summary

Trade executed successfully at 09:35 ET. Dashboard showed missing P&L, delta, and margin for the new position. Root cause not definitively identified due to premature restart.

---

## Trade Executed

| Field | Value |
|-------|-------|
| Contract | SPY 632P 2026-04-30 |
| Action | SELL 1 |
| Fill Price | $5.95 |
| Position ID | 17 |
| Fill Time | 09:35:52 ET |

---

## Issue: Dashboard Missing Live Data

### Symptoms

- New position (ID 17) was in database
- Dashboard showed position but with "--" for P&L, delta, margin
- Other positions (ID 1-16) displayed correctly

### Investigation

1. Checked `/api/positions` (DB): 16 positions including ID 17
2. Checked `/api/positions/live` (cache): Only 15 positions, ID 17 missing
3. Cache refresh runs every ~5 seconds via `_update_positions()`
4. Trade completed at 09:36, checked at ~10:38 - over 1 hour of refresh cycles

### The Mystery

The cache should refresh from DB every 5 seconds:
```
_update_positions():
    _load_db_positions()     â†’ Fresh DB query each time
    for pos in _db_positions:
        enriched.append(...)
    cache.positions = enriched
    cache.last_update = now()
```

If `_load_db_positions()` returns 16 positions, cache should have 16. But it had 15.

### What We Don't Know

- Did `_load_db_positions()` fail silently? (No error in logs)
- Did the DB query return stale data? (Shouldn't with fresh connections)
- No logging exists to show what `_db_positions` contained

### Resolution

Restarted `ibkr-bot` container - cache immediately showed all 16 positions correctly.

**Mistake**: Should NOT have restarted before fully diagnosing. The broken state was valuable evidence.

---

## Changes Made

### 1. Updated CLAUDE.md - Debugging Workflow

Added rule: Do not fix or restart before finding root cause. The broken state is valuable.

### 2. Added Cache Timestamps to API

`/api/positions/live` now returns:
- `positions_count`: Number of positions in cache
- `cache_updated_at`: When cache was last refreshed

This helps diagnose if cache is stale vs just missing data.

---

## Known Limitation

The `cache_updated_at` timestamp only shows when the refresh loop ran, NOT when DB load succeeded. If `_load_db_positions()` fails silently, timestamp will be fresh but data will be stale.

Future improvement: Track `db_loaded_at` separately to detect DB load failures.

---

## Files Modified

| File | Change |
|------|--------|
| `CLAUDE.md` | Added debugging workflow - don't restart before diagnosing |
| `src/ibkr_spy_puts/api.py` | Added `positions_count` and `cache_updated_at` to live endpoint |

---

## Pending

1. Add `db_loaded_at` timestamp to track when DB query last succeeded (separate from cache refresh time)
2. Consider adding position count logging only when count changes
