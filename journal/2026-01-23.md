# Journal - 2026-01-23

## Summary

Dashboard improvements and bug fixes day. Added login button for 2FA restart, implemented persistent connection manager to eliminate status flickering, fixed SPY price display (BATS exchange), and fixed P&L calculation to show per-position values.

---

## Completed

### 1. Login Button for 2FA Restart
Added a login button that appears when the gateway is not logged in, triggering a container restart to prompt 2FA.

**Files modified:**
- `api.py` - Added `/api/gateway/restart` endpoint using Docker socket API
- `dashboard.html` - Added login button with spinner animation
- `docker-compose.yml` - Mounted Docker socket into trading-bot container

**How it works:**
1. Login button appears when `logged_in=false`
2. Clicking triggers POST to `/api/gateway/restart`
3. Dashboard polls every 3 seconds for 2FA completion
4. User authenticates via IBKR mobile app

### 2. Persistent Connection Manager
Created background thread that maintains a single persistent connection to IB Gateway, eliminating dashboard status flickering.

**New file:** `connection_manager.py`
- Background thread with own event loop
- Updates cache every 5 seconds (status, orders, positions, SPY price)
- Dashboard endpoints read from cache instantly (no IBKR latency)
- Uses `clientId=50` (read-only, separate from trading `clientId=0`)

**Files modified:**
- `api.py` - Updated endpoints to use connection manager
  - Startup/shutdown events for manager lifecycle
  - Status, orders, positions read from cache

### 3. Fixed SPY Price Display
SPY price was showing null due to ARCA exchange subscription requirements.

**Root cause:** SMART routing picked ARCA which requires additional subscription
**Fix:** Use BATS exchange (covered by existing Cboe One subscription)

**Changes in `connection_manager.py`:**
```python
# Use live data (type 1) instead of delayed (type 3)
self.ib.reqMarketDataType(1)
# Use BATS instead of SMART
self._spy_contract = Stock("SPY", "BATS", "USD")
```

### 4. Fixed P&L Calculation Bug
Multiple positions of the same contract were showing identical P&L because IBKR reports aggregate P&L per contract type.

**Root cause:** `unrealized_pnl` from IBKR is per-contract, not per-position
**Fix:** Calculate P&L using entry price and current price per position

**Formula (short puts):**
```
P&L = (entry_price - current_price) * 100 * quantity
P&L % = P&L / (entry_price * 100 * quantity) * 100
```

**Example (verified):**
| Position | Strike | Entry | Current | P&L | P&L % |
|----------|--------|-------|---------|-----|-------|
| 9 | 625 | $5.48 | $5.07 | $41.00 | 7.48% |
| 8 | 625 | $5.69 | $5.07 | $62.00 | 10.90% |

---

## Verification Status

### Live Trading (EC2)
| Check | Status |
|-------|--------|
| Connection | Connected (U2619432 - Live) |
| Login | Logged in |
| Ready to Trade | Yes |
| Positions | 9 (with correct individual P&L) |
| SPY Price | Displays correctly via BATS |
| URL | http://98.88.118.228:8000 |

---

## Files Modified

| File | Change |
|------|--------|
| `api.py` | Gateway restart endpoint, P&L calculation fix |
| `connection_manager.py` | New persistent connection manager |
| `dashboard.html` | Login button, status sync |
| `docker-compose.yml` | Docker socket mount |

---

## Commits

1. `Calculate P&L per position using entry price and current price`
   - Hash: 86ec8c7

---

## Next Steps (for future sessions)

1. Monitor trading execution during market hours
2. Consider adding position age and total P&L to dashboard
3. Add alert for gateway disconnection
4. Consider adding historical P&L tracking
