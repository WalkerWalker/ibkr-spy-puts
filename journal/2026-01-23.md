# Journal - 2026-01-23

## Summary

Major refactoring day. Fixed SPY price display (delayed data type 3), cleaned up dead code, and consolidated all IBKR reads into a single connection manager. The dashboard now reads from a streaming cache instead of spawning subprocesses.

---

## Completed

### 1. Fixed SPY Price Display
SPY price was showing "No subscription" (error 10089) because live data requires paid market data subscriptions.

**Root cause:** Using `reqMarketDataType(1)` (live) triggers error 10089 "Requested market data requires additional subscription for API... SPY ARCA/TOP/ALL"

**Fix:** Use delayed data type (3) which doesn't require subscription:

```python
self.ib.reqMarketDataType(3)  # Delayed - no subscription required
self._spy_contract = Stock("SPY", "SMART", "USD")
self._spy_ticker = self.ib.reqMktData(self._spy_contract, "", False, False)
```

**Key insight:** Tick type "106" (implied volatility) is for options, not stocks. Use empty string "" for stock quotes.

### 2. Code Cleanup
Removed 130+ lines of unnecessary code:
- Removed `_fetch_spy_price()` function that used `reqHistoricalData` (dead code)
- Removed redundant SPY fetch from positions subprocess
- Removed unused imports (`Stock`, `math`) and functions (`is_valid_price`)

### 3. Consolidated IBKR Reads into Connection Manager
**Before:** Positions endpoint spawned a subprocess to fetch Greeks, margin, P&L (170+ lines, 60s timeout)
**After:** Connection manager caches everything, endpoint just reads from cache (~15 lines, instant)

**Connection Manager now handles:**
- SPY price (streaming subscription)
- Option Greeks for all positions (streaming with tick type 106)
- Margin per position (via whatIfOrder)
- P&L calculation (entry_price - current_price)
- Open orders
- Connection status

**Cache update mechanism:**
- Background thread with dedicated event loop
- Updates every ~5-7 seconds (time-triggered)
- `ib.sleep(5)` processes streaming events and waits
- DB positions reloaded each cycle to pick up new trades

**Architecture:**
```
┌─────────────────────────────────────────────────────────┐
│                    Connection Manager                     │
│  (clientId=50, readonly=False for whatIfOrder)           │
│                                                           │
│  Streams: SPY price, option Greeks                       │
│  Fetches: orders, positions, margin                      │
│  Calculates: P&L, days to expiry                         │
│                                                           │
│  Cache updated every 5 seconds                           │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                     FastAPI Endpoints                     │
│                                                           │
│  /api/positions/live  → manager.get_positions()          │
│  /api/spy-price       → manager.get_spy_price()          │
│  /api/connection-status → manager.get_status()           │
│  /api/live-orders     → manager.get_orders()             │
│                                                           │
│  All reads are instant (from cache)                      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    Scheduler/Trader                       │
│  (clientId=1, separate connection)                       │
│                                                           │
│  Triggered at 09:35 ET                                   │
│  Places trades, manages orders                           │
│  Uses own IBKR connection for trading                    │
└─────────────────────────────────────────────────────────┘
```

---

## Technical Details

### readonly=False for Connection Manager
- Required for `whatIfOrder()` (margin calculation simulates placing an order)
- SPY delayed data works regardless of readonly setting
- Trading is still done by scheduler with separate connection

### ib.sleep() Explained
- Required by ib_insync to process the event loop
- NOT a regular sleep - it processes incoming market data events
- Without it, streaming tickers would never receive updates
- Duration (5 seconds) is a balance between responsiveness and load

### Tick Types
- Empty string "" - basic price data (last, bid, ask, close)
- "106" - implied volatility and model Greeks (for options)
- "101" - open interest

---

## Verification Status

### Live Trading (EC2)
| Check | Status |
|-------|--------|
| Connection | Connected (U2619432 - Live) |
| SPY Price | $689.64 via delayed data |
| Positions | 9 with Greeks and P&L |
| Data Source | Streaming cache |
| URL | http://98.88.118.228:8000 |

---

## Files Modified

| File | Change |
|------|--------|
| `connection_manager.py` | Complete rewrite - now fetches positions, Greeks, margin |
| `api.py` | Removed subprocess, endpoints read from cache |

---

## Commits

1. `Fix SPY price: use delayed data type (3) instead of live (1)` - 2ed4291
2. `Fix SPY in positions endpoint: use empty tick type like working test` - ff90f9f
3. `Clean up SPY price code: remove dead code and redundant fetching` - 7e85156
4. `Consolidate all IBKR reads into connection manager` - 877fb60

---

## Architecture Summary

**Connection Manager (for dashboard reads):**
- Single persistent connection (clientId=50)
- Background thread with own event loop
- Streams SPY and option prices
- Caches all data, refreshed every 5 seconds
- readonly=False (needed for margin calculation)

**Scheduler/Trader (for trading):**
- Separate connection (clientId=1)
- Triggered at 09:35 ET
- Places sell orders, TP/SL orders
- Has trading privileges

**Key benefit:** Dashboard endpoints are now instant (read from cache) instead of waiting 60+ seconds for subprocess.

---

## Next Steps (for future sessions)

1. Monitor trading execution during market hours
2. Verify margin calculation works correctly with whatIfOrder
3. Consider adding last_update timestamp to dashboard UI
4. Add error handling for stale cache data
