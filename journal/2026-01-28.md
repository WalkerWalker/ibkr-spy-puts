# Journal - 2026-01-28 (Wednesday)

## Summary

**Critical Issue:** Scheduled trade selected wrong strike (698P instead of ~631P) due to IBKR returning delta for only 3/132 options at market open. User closed bad position with loss. Manual trade re-executed at correct strike (631P).

---

## Issue: Wrong Strike Selection

### What Happened

| Time | Event |
|------|-------|
| 09:31:29 | Scheduled trade executed: SPY 698P @ $18.88 |
| ~09:35 | User noticed wrong strike (698 is near-ATM, not ~630 target) |
| ~09:40 | User manually closed position with loss |
| 09:50:21 | Gateway restart with 2FA |
| 09:56:19 | Manual trade executed: SPY 631P @ $6.25 |

### Root Cause

IBKR returned `modelGreeks.delta` for only 3 out of 132 options at 09:31.

| Date | Options | With Delta | % |
|------|---------|------------|---|
| 01-26 attempt 1 | 126 | 70 | 56% |
| 01-26 attempt 2 | 126 | 94 | 75% |
| 01-27 | 130 | 50 | 38% |
| **01-28** | **132** | **3** | **2%** |

All 3 options with delta were near-ATM (delta ~-0.46 to -0.48):
- 697P: delta=-0.46
- 698P: delta=-0.47
- 699P: delta=-0.48

Algorithm correctly selected "closest to -0.15" but when only ATM options have data, it picks the wrong strike.

### After 2FA Restart (09:50)

Delta availability returned to normal:
```
Testing 131 options...
131/131 have valid delta (100%)
Strike 630: delta=-0.1496 (closest to target -0.15)
```

---

## Completed

### 1. Closed Bad Position

User manually closed SPY 698P 2026-04-30 with loss.

### 2. Manual Trade Re-Execution

**New Position:**
| Field | Value |
|-------|-------|
| Position ID | 12 |
| Contract | SPY 631P 2026-04-30 |
| Fill Price | $6.25 |
| Fill Time | 09:56:19 ET |

---

## Completed Fix

Modified `src/ibkr_spy_puts/ibkr_client.py`:

### 1. Increased Wait Time + Retry Logic (lines 313-340)

```python
# In get_option_chain_with_greeks()
initial_wait = 5  # Increased from 3s to 5s
retry_wait = 3    # Additional wait per retry
max_retries = 3
min_delta_pct = 0.20  # Require at least 20% to have delta

# Retry loop with logging
for retry in range(max_retries):
    with_delta = sum(1 for _, t in tickers if t.modelGreeks and t.modelGreeks.delta)
    if with_delta / total >= min_delta_pct:
        break
    self.ib.sleep(retry_wait)
```

### 2. Safeguard - Abort if No Valid Delta (lines 423-442)

```python
# In find_put_by_delta()
delta_min = -0.25  # At least this far OTM
delta_max = -0.08  # At most this far OTM
options_in_range = [opt for opt in options_with_delta if delta_min <= opt.delta <= delta_max]

if not options_in_range:
    logger.error("ABORTING: No option with delta in target range")
    return None
```

This prevents selecting ATM options when only they have delta data.

---

## Pending

1. **Clean up bracket orders** from bad 698P trade (orphaned TP/SL orders in IBKR)
2. ~~**Implement delta fix** - retry logic and safeguard~~ âœ“ DONE
3. IBKR PGP key issue - waiting for them to re-import correct key
4. Store `conId` in database for weekend position verification
5. Deploy fix to EC2

---

## Verification Status

| Check | Status |
|-------|--------|
| Connected | Yes (LIVE U2619432 on EC2) |
| Bad Position | Closed manually |
| New Position | SPY 631P 2026-04-30 @ $6.25 |
| Orphaned Orders | Need cleanup (698P TP/SL) |
