# Journal - 2026-01-28 (Wednesday)

## Summary

**Critical Issue:** Scheduled trade selected wrong strike (698P instead of ~631P) due to IBKR returning delta for only 3/132 options at market open. User closed bad position with loss. Manual trade re-executed at correct strike (631P).

---

## Issue: Wrong Strike Selection

### What Happened

| Time | Event |
|------|-------|
| 09:31:29 | Scheduled trade executed: SPY 698P @ $18.88 |
| ~09:35 | User noticed wrong strike (698 is near-ATM, not ~630 target) |
| ~09:40 | User manually closed position with loss |
| 09:50:21 | Gateway restart with 2FA |
| 09:56:19 | Manual trade executed: SPY 631P @ $6.25 |

### Root Cause

IBKR returned `modelGreeks.delta` for only 3 out of 132 options at 09:31.

| Date | Options | With Delta | % |
|------|---------|------------|---|
| 01-26 attempt 1 | 126 | 70 | 56% |
| 01-26 attempt 2 | 126 | 94 | 75% |
| 01-27 | 130 | 50 | 38% |
| **01-28** | **132** | **3** | **2%** |

All 3 options with delta were near-ATM (delta ~-0.46 to -0.48):
- 697P: delta=-0.46
- 698P: delta=-0.47
- 699P: delta=-0.48

Algorithm correctly selected "closest to -0.15" but when only ATM options have data, it picks the wrong strike.

### After 2FA Restart (09:50)

Delta availability returned to normal:
```
Testing 131 options...
131/131 have valid delta (100%)
Strike 630: delta=-0.1496 (closest to target -0.15)
```

---

## Completed

### 1. Closed Bad Position

User manually closed SPY 698P 2026-04-30 with loss.

### 2. Manual Trade Re-Execution

**New Position:**
| Field | Value |
|-------|-------|
| Position ID | 12 |
| Contract | SPY 631P 2026-04-30 |
| Fill Price | $6.25 |
| Fill Time | 09:56:19 ET |

---

## Completed Fix

Modified `src/ibkr_spy_puts/ibkr_client.py`:

### 1. Increased Wait Time + Retry Logic (lines 313-340)

```python
# In get_option_chain_with_greeks()
initial_wait = 5  # Increased from 3s to 5s
retry_wait = 3    # Additional wait per retry
max_retries = 3
min_delta_pct = 0.20  # Require at least 20% to have delta

# Retry loop with logging
for retry in range(max_retries):
    with_delta = sum(1 for _, t in tickers if t.modelGreeks and t.modelGreeks.delta)
    if with_delta / total >= min_delta_pct:
        break
    self.ib.sleep(retry_wait)
```

### 2. Safeguard - Require Consecutive Boundary (lines 423-456)

```python
# In find_put_by_delta()
# Find consecutive strikes that bracket target delta
sorted_chain = sorted(chain, key=lambda x: x.strike)

boundary_pair = None
for i in range(len(sorted_chain) - 1):
    curr = sorted_chain[i]
    next_opt = sorted_chain[i + 1]

    # Both consecutive strikes must have delta
    if curr.delta is None or next_opt.delta is None:
        continue

    # Check if they bracket target
    if curr.delta > target_delta > next_opt.delta:
        boundary_pair = (curr, next_opt)
        break

if boundary_pair is None:
    logger.error("ABORTING: No consecutive strikes bracket target delta")
    return None
```

This ensures:
- One strike with delta above -0.15
- One strike with delta below -0.15
- They are **consecutive** (no missing strike in between)

---

## Pending

1. **Clean up bracket orders** from bad 698P trade (orphaned TP/SL orders in IBKR)
2. ~~**Implement delta fix** - retry logic and safeguard~~ ✓ DONE
3. ~~IBKR PGP key issue~~ ✓ FIXED - decryption now works with key `CB8958A6EC3AF1C3`
4. Store `conId` in database for weekend position verification
5. ~~Deploy fix to EC2~~ ✓ DONE - image rebuilt and deployed

---

## PGP Decryption Fixed

IBKR re-imported the correct PGP key. Margin report now decrypts successfully:

```
gpg: encrypted with rsa4096 key, ID CB8958A6EC3AF1C3
Account: U2619432
Net Liquidation: $424,825.58
Maintenance Margin: $116,059.67
Excess Liquidity: $308,765.90
```

Positions in report:
- SPY 610P 04/17: -1
- SPY 615P 04/17: -1
- SPY 625P 04/17: -3
- SPY 630P 04/17: -4
- SPY 625P 04/30: -1
- SPY 629P 04/30: -1
- SPY 631P 04/30: -1 (new)

---

## Verification Status

| Check | Status |
|-------|--------|
| Connected | Yes (LIVE U2619432 on EC2) |
| Bad Position | Closed manually |
| New Position | SPY 631P 2026-04-30 @ $6.25 |
| Orphaned Orders | Need cleanup (698P TP/SL) |
