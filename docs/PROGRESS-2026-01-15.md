# Development Progress - 2026-01-15

## Summary of Yesterday's Session (2026-01-14)

### Issues Fixed

1. **SPY Price Unavailable for Option Chain**
   - Problem: Market data subscription error prevented getting SPY price to filter strikes
   - Solution: Added fallback to $600 estimate when SPY price unavailable
   - File: `ibkr_client.py:235-247`

2. **Take Profit Order Not Being Placed**
   - Problem: Bracket order used parent-child linking which failed when parent filled quickly
   - Solution: Changed to standalone GTC orders in OCA group placed after parent is accepted
   - File: `ibkr_client.py:521-591`

3. **TP/SL Prices Based on Wrong Price**
   - Problem: TP/SL calculated from limit price, not actual fill price
   - Solution: Now uses fill price for both order creation and database recording
   - Files: `ibkr_client.py:551-562`, `scheduler.py:303-319`

4. **Database TP/SL Discrepancy (Trade 17)**
   - Problem: Trade 17 had $2.35/$17.64 instead of correct $2.41/$18.09
   - Solution: Manually updated database to match IBKR live orders

5. **Greeks Calculation Wrong**
   - Problem: Raw delta shown instead of SPY-equivalent delta
   - Solution: Now shows SPY Delta (delta × 100 × quantity) and Theta Income (+$/day)

### Dashboard Improvements

1. **Live P&L Display**
   - Added `/api/positions/live` endpoint that fetches real-time data from IBKR
   - Shows Current Price, P&L ($ and %), updates every 2 minutes

2. **Position-Order Relationship**
   - Added `get_positions_with_orders()` to fetch positions with linked TP/SL orders
   - Dashboard shows positions in table with expandable orders underneath
   - Removed separate Live Orders section - orders now under their positions

3. **Greeks Display**
   - SPY Delta: Shows equivalent SPY share exposure (e.g., "52 SPY")
   - Theta Income: Shows daily theta decay income (e.g., "+$27/day")

### Database Changes

- Added orders for trade 18 (625P)
- Fixed trade 17 orders to correct TP/SL prices
- Orders table now properly linked to trades via `trade_id`

### Files Modified

| File | Changes |
|------|---------|
| `ibkr_client.py` | SPY price fallback, bracket order fix, fill price for TP/SL |
| `scheduler.py` | Use fill price for database recording |
| `database.py` | Added `get_positions_with_orders()` method |
| `api.py` | Added `/api/positions/live`, updated dashboard to use positions with orders |
| `dashboard.html` | Table format, expandable orders, live P&L, correct Greeks |

### Current State

- **3 Open Positions**: 630P×2, 625P×1 (all exp 2026-04-17)
- **SPY Delta**: ~52 SPY equivalent
- **Theta Income**: ~$27/day
- **DRY_RUN**: false (live trading enabled)
- **Trade Time**: 09:35 ET daily

---

## Today's Goals (2026-01-15)

1. Start all containers
2. Verify IBKR connection and readiness
3. Wait for 09:35 trade execution
4. Verify new trade recorded correctly in database
